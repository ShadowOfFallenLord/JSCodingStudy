@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="~/Content/RobotStyles/Styles.css" type="text/css" />

<div class="row align-items-start borders" id="page_top_row">
    <div class="col-lg-5 borders">
        <div id="robot_display" class="display_table" align="center">
            display
        </div>
    </div>
    <div class="col-lg-7 full_height borders">
        <div class="row borders">
            <div class="col-lg-4 borders">
                Действия:
            </div>
            <div class="col-lg-8 borders">
                Задание:
            </div>
        </div>
        <div class="row full_height borders">
            <div class="col-lg-4 full_height borders">
                <textarea id="log_display" readonly="true" class="form-control"></textarea>
            </div>
            <div class="col-lg-8 full_height borders">
                @RenderSection("task", required: true)
            </div>
        </div>
    </div>
</div>
<div class="row align-items-center borders" id="page_bottom_row">
    <div class="col-lg-5 full_height borders">
        <div class="borders">
            Код:
        </div>
        <div class="borders full_height">
            <textarea id="code_input" class="form-control text-left" rows="2"></textarea>
        </div>
    </div>
    <div class="col-lg-7 full_height text-center button_container borders">
        <input type="button" id="run_button" value="Запуск" class="btn btn-primary">
        <input type="button" id="clear_button" value="Сброс" class="btn btn-primary">
        <input type="button" id="help_button" value="Помощь" class="btn btn-primary">
        @Html.ActionLink("Назад", "Index", "Menu", null, new { @class = "btn btn-primary" })
    </div>
</div>

<div id="help_container" class="help_container borders_inside" style="display: none;">
    <input type="button" id="close_help_button" value="X">
    <ul id="help_text" style="padding: 5px;">
        Справка по командам
    </ul>
</div>

<!-- Основные элементы -->
<script>
    var html_elements = {
        // Контейнер экрана робота.
        RobotDisplay: $('#robot_display'),
        // Элемент ввода кода.
        TextInput: $('#code_input'),
        // Элемент с логом.
        LogDisplay: $('#log_display'),
        // Кнопки.
        Buttons: {
            // Кнопка запуска.
            RunButton: $('#run_button'),
            // Кнопка сброса.
            ClearButton: $('#clear_button'),
            // Кнопка со справкой.
            HelpButton: $('#help_button'),
        }
    }
</script>

<!-- Открытие/закрытие окошка помощи -->
<script>
    var HelpContainer = $('#help_container');
    var doc = $('html');

    $('#close_help_button').click(function () {
        HelpContainer.hide();
    });

    html_elements.Buttons.HelpButton.click(function () {
        HelpContainer.show();

        var screen_width = doc.width();
        var screen_heigth = doc.height();

        var element_width = HelpContainer.width();
        var element_heigth = HelpContainer.height();

        HelpContainer.css({
            left: ((screen_width / 2) - (element_width / 2)),
            top: ((screen_heigth / 2) - (element_heigth / 2)),
        });
    });
</script>

<!-- Содержание окошка помощи -->
<script type="module">
    import * as RAPI from "@Url.Content("~/Scripts/Robot/RobotAPI/GeneralRobotAPI.js")";
    var help = RAPI.GetHelpAPI();
    var help_test = $('#help_text');

    @if (IsSectionDefined("help"))
    {
        @RenderSection("help")
    }
    else
    {
        @:var help_node = help.ParseHelp(help.GetHelp(true, true, true));
    }
    help_test.html(help_node);
</script>

<!-- Подтягивание API робота -->
<script type="module">
    import * as RAPI from "@Url.Content("~/Scripts/Robot/RobotAPI/GeneralRobotAPI.js")";

    const delay = 100;

    @if (IsSectionDefined("field_init"))
    {
        @RenderSection("field_init")
    }
    else
    {
        @:var RobotAPI = RAPI.CreateFullRobotAPI(10, 10, true, 5, 5, html_elements.LogDisplay, delay);
    }

    html_elements.RobotDisplay.html(RobotAPI.Field.FieldElement);

    html_elements.Buttons.ClearButton.click(RobotAPI.Reset);
    html_elements.Buttons.RunButton.click(function() {
        var code = html_elements.TextInput.text();

        function additional_result_check() {
            var res_int = RobotAPI.CheckResults();
            var res_str = RobotAPI.GetResultString(res_int);

            if (res_int == 0) {
                // Место для отправки успешного кода на сервер
            }

            alert(res_str);
        }

        RobotAPI.Execute(code, additional_result_check);
    });
</script>

<!-- Установка пользовательского кода -->
<script>
    @if (IsSectionDefined("user_code"))
    {
        @RenderSection("user_code")
    }
    else
    {
         @:html_elements.TextInput.html('');
    }
</script>

@section scripts {
    <!-- Растягивание "таблицы" на весь экран -->
    <script>
        (function () {
            var height = $('#main_page_container').height();
            var hp = height / 3;

            $('#page_top_row').height(hp * 2);
            $('#page_bottom_row').height(hp);
        })();
    </script>
}