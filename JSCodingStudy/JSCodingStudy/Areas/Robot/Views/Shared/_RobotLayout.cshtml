@{
    Layout = "~/Views/Shared/_Layout.cshtml";

    bool IsLesson = (bool)ViewBag.IsLesson;
    int LessonId = (int)ViewBag.LessonId;
}

<link rel="stylesheet" href="~/Content/RobotStyles/Styles.css" type="text/css" />

<div class="row align-items-start borders" id="page_top_row">
    <div class="col-5 borders">
        <div id="robot_display" class="display_table" align="center">
            display
        </div>
    </div>
    <div class="col-7 h-100 borders">
        <div class="row borders">
            <div class="col-4 borders">
                Действия:
            </div>
            <div class="col-8 borders">
                Задание:
            </div>
        </div>
        <div class="row h-100 borders">
            <div class="col-4 h-100 borders">
                <textarea id="log_display" readonly="true" class="form-control h-100 w-100"></textarea>
            </div>
            <div class="col-8 h-100 borders">
                @RenderSection("task", required: true)
            </div>
        </div>
    </div>
</div>
<div class="row align-items-center borders" id="page_bottom_row">
    <div class="col-5 h-100 borders">
        <div class="borders">
            Код:
        </div>
        <div class="borders h-100">
            <textarea id="code_input" class="form-control text-left h-100 w-100"></textarea>
        </div>
    </div>
    <div class="col-7 h-100 text-center mt-8 borders">
        <input type="button" id="run_button" value="Запуск" class="btn btn-primary">
        <input type="button" id="clear_button" value="Сброс" class="btn btn-primary">
        <input type="button" id="help_button" value="Помощь" class="btn btn-primary">
        @Html.ActionLink("Назад", "Index", "Menu", null, new { @class = "btn btn-primary" })
    </div>
</div>

<div id="help_container" class="position-absolute bg-light borders borders_inside" style="display: none;">
    <input type="button" id="close_help_button" value="X">
    <ul id="help_text" style="padding: 5px;">
        Справка по командам
    </ul>
</div>

<div id="result_container" class="position-absolute bg-light borders borders_inside" style="display: none;">
    <div id="result_message">
        Результат
    </div>
    <input type="button" id="save_result_button" value="Сохранить" class="btn btn-success">
    <input type="button" id="close_result_button" value="Продолжить" class="btn btn-primary">
</div>

<!-- Основные элементы -->
<script>
    var html_elements = {
        // Контейнер экрана робота.
        RobotDisplay: $('#robot_display'),
        // Элемент ввода кода.
        TextInput: $('#code_input'),
        // Элемент с логом.
        LogDisplay: $('#log_display'),
        // Кнопки.
        Buttons: {
            // Кнопка запуска.
            RunButton: $('#run_button'),
            // Кнопка сброса.
            ClearButton: $('#clear_button'),
            // Кнопка со справкой.
            HelpButton: $('#help_button'),
        }
    }
</script>

<!-- Подтягивание API переключателя всплывающих окошек -->
<script src="~/Scripts/Other/PopUpContainerToggle.js"></script>

<!-- Открытие/закрытие окошка помощи -->
<script>
    (function () {
        var HelpContainer = $('#help_container');

        var toggle = PopUpToggleInit(HelpContainer, FullBody);

        $('#close_help_button').click(toggle.Hide);
        html_elements.Buttons.HelpButton.click(toggle.ShowInCenter);
    })();
</script>

<!-- Содержимое окошка помощи -->
<script type="module">
    import * as RAPI from '@Url.Content("~/Scripts/Robot/RobotAPI/GeneralRobotAPI.js")';
    var help = RAPI.GetHelpAPI();
    var help_test = $('#help_text');

    @if (IsSectionDefined("help"))
    {
        @RenderSection("help")
    }
    else
    {
        @:var help_node = help.ParseHelp(help.GetHelp(true, true, true));
    }
    help_test.html(help_node);
</script>

<!-- Подтягивание API инифиализации функций для контейнера с результатом -->
<script src="~/Scripts/Other/ResultContainerFunctionsInit.js"></script>

<!-- Настройка окошка результата -->
<script>
    var ResultContainer = {
        ContainerElement: $('#result_container'),
        MessageElement: $('#result_message'),
        Buttons: {
            Save: $('#save_result_button'),
            Close: $('#close_result_button'),
        },
    };

    ResultContainer.Toggle = PopUpToggleInit(ResultContainer.ContainerElement, FullBody);

    ResultContainer.Functions = InitResultContainerFinctions(ResultContainer);

    ResultContainer.Buttons.Close.click(ResultContainer.Functions.Hide);
</script>

@if (IsLesson)
{
    @Html.Partial("_LessonAjaxScriptsPartial", LessonId)
}
else
{
    <!-- Для песочницы нельзя сохранить полученное решение -->
    <script>
        ResultContainer.Buttons.Save.addClass('hidden');
    </script>
}

<!-- Подтягивание API и настройка робота -->
<script type="module">
    import * as RAPI from '@Url.Content("~/Scripts/Robot/RobotAPI/GeneralRobotAPI.js")';

    const delay = 100;

    @if (IsSectionDefined("field_init"))
    {
        @RenderSection("field_init")
    }
    else
    {
        @:var RobotAPI = RAPI.CreateFullRobotAPI(10, 10, true, 5, 5, html_elements.LogDisplay, delay);
    }

    html_elements.RobotDisplay.html(RobotAPI.Field.FieldElement);

    html_elements.Buttons.ClearButton.click(RobotAPI.Reset);
    html_elements.Buttons.RunButton.click(function () {
        var code = html_elements.TextInput.val();

        function additional_result_check() {
            var res_int = RobotAPI.CheckResults();
            var res_str = RobotAPI.GetResultString(res_int);

            ResultContainer.Functions.Handle(res_int, res_str);

            @if (IsLesson)
            {
                @:if (res_int == 0) ResultContainer.Functions.SendSuccess();
            }
        }

        RobotAPI.Execute(code, additional_result_check);
    });
</script>

<!-- Установка пользовательского кода -->
<script>
    @if (IsSectionDefined("user_code"))
    {
        @RenderSection("user_code")
    }
    else
    {
         @:html_elements.TextInput.val('');
    }
</script>

@section scripts {
    <!-- Растягивание "таблицы" на весь экран -->
    <script>
        (function () {
            var height = $('#main_page_container').height();
            var hp = height / 3;

            $('#page_top_row').height(hp * 2);
            $('#page_bottom_row').height(hp);
        })();
    </script>
}