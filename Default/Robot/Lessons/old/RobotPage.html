<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Robot</title>
</head>
<body>
    <style>
        body * {
            font-family: Consolas;
            border: solid 1px black;
        }

        .main_page_container {
            position: absolute;
            top: 5%;
            left: 5%;
            width: 90%;
            height: 90%;
        }

        .all_width_container {
            width: 100%;
        }

        .game_screen {
            height: 100%;
        }

        .game_screen::selection {
            background: transparent;
        }

        .input_container {
            height: 25%;
            width: 50%;
        }
    </style>
    <style>
        .clear_cell {
            background-color: white;
            color: black;
        }
        .fill_cell {
            background-color: black;
            color: white;
        }
    </style>
    <div class="main_page_container" align="center">
        <table width="100%" class="game_screen">
            <tr>
                <td>
                    <div id="main_display" class="all_width_container">
                        main disp
                    </div>
                </td>
                <td>
                    <textarea id="loger_area" readonly="true" style="height: 100%;"></textarea>
                </td>
            </tr>
            <tr>
                <td>
                    <textarea id="main_input" class="input_container" style="height: 100%;"></textarea>
                </td>
                <td>
                    <input type="button" id="run_button" value="Run">
                    <input type="button" id="clear_button" value="Clear">
                </td>
            </tr>
        </table>
    </div>
    <script>

        function InitLogerClass()
        {
            var instance = this;

            instance.html_element = document.getElementById('loger_area');

            instance.Clear = function()
            {
                instance.html_element.innerText = '';
            }

            instance.Log = function(str)
            {
                var text =  instance.html_element.innerHTML;
                text = text + str + '\n';
                instance.html_element.innerHTML = text;
                text == text;
            }

            return instance;
        }

        var MainDisp = document.getElementById('main_display');
        var TextInput = document.getElementById('main_input');
        var Loger = InitLogerClass();
        var RunButton = document.getElementById('run_button');
        var ClearButton = document.getElementById('clear_button');

        const Configuration = {
            FieldWidth: 10,
            FieldHeight: 10
        }

        const CellType = {
            Void: 0,
            Wall: 1
        }

        const CellContent = {
            Void: '&nbsp;',
            Wall: '#',
            Robot: '@',
        }

        const Directions = {
            Up:    { x_offset:  0, y_offset: -1, text: "up" },
            Right: { x_offset:  1, y_offset:  0, text: "right" },
            Down:  { x_offset:  0, y_offset:  1, text: "down" },
            Left:  { x_offset: -1, y_offset:  0, text: "left" },
        }
        
        var Player = {
            Destroed: false,
            X: (Configuration.FieldWidth / 2) | 0,
            Y: (Configuration.FieldHeight / 2) | 0,
            oldX: (Configuration.FieldWidth / 2) | 0,
            oldY: (Configuration.FieldHeight / 2) | 0,
        }

        function InitGameField()
        {
            var res = {
                html_element: document.createElement('table'),
                elements: [],
                drawed_elements: []
            }

            function clear_field()
            {
                res.drawed_elements.forEach(element => {
                    element.setAttribute('class', 'clear_cell')
                });
                res.drawed_elements = [];
            }

            res.clear = clear_field;

            for(var i = 0; i < Configuration.FieldHeight; i++)
            {
                var html_elem = document.createElement('tr');
                html_elem.setAttribute('align', 'center');
                res.html_element.append(html_elem);
                res.elements[i] = {
                    html_element: html_elem,
                    elements: []
                }
            }

            for(var y = 0; y < Configuration.FieldHeight; y++)
            {
                var line_parrent = res.elements[y].html_element;
                var line_array = res.elements[y].elements;
                for(var x = 0; x < Configuration.FieldWidth; x++)
                {
                    var html_elem = document.createElement('td');
                    html_elem.innerHTML = CellContent.Void;
                    html_elem.setAttribute('width', '19px')
                    html_elem.setAttribute('class', 'clear_cell')
                    line_parrent.append(html_elem);

                    function getOnClickFunc(tx, ty)
                    {
                        return function()
                        {
                            if(Player.X == tx && Player.Y == ty) return;

                            var t = res.elements[ty].elements[tx];

                            if(t.type == CellType.Void)
                            {
                                t.type = CellType.Wall;
                                t.html_element.innerHTML = CellContent.Wall;
                            }
                            else
                            {
                                t.type = CellType.Void;
                                t.html_element.innerHTML = CellContent.Void;
                            }
                        }
                    }

                    html_elem.onclick = getOnClickFunc(x, y);


                    function get_draw_func(tx, ty)
                    {
                        return function draw_func()
                        {
                            var t = res.elements[ty].elements[tx];

                            t.html_element.setAttribute('class', 'fill_cell');
                            res.drawed_elements.push(t.html_element);
                        }
                    }

                    var elem = {
                        html_element: html_elem,
                        type: CellType.Void,
                        draw: get_draw_func(x, y)
                    }

                    line_array[x] = elem;
                }
            }

            return res;
        }

        var GameField = InitGameField();
        MainDisp.innerHTML = '';
        MainDisp.append(GameField.html_element);

        function ReDrawPlayer()
        {
            var t = GameField
                .elements[Player.oldY]
                .elements[Player.oldX];

            if(t.type == CellType.Void)
            {
                t.html_element.innerHTML = CellContent.Void;
            }
            else
            {
                t.html_element.innerHTML = CellContent.Wall;
            }

            GameField
                .elements[Player.Y]
                .elements[Player.X]
                .html_element.innerHTML = CellContent.Robot;  

            Player.oldX = Player.X;          
            Player.oldY = Player.Y; 
        }
        
        ReDrawPlayer();
    </script>
    <script>
        function InitRobotControlClass()
        {
            var instance = function() {};

            instance.destroy = function()
            {
                Player.Destroed = true;
                Loger.Log('destroy');
            }

            instance.move = function(direction)
            {
                if(Player.Destroed) return;

                var tx = Player.X + direction.x_offset;
                var ty = Player.Y + direction.y_offset;
                
                if(tx < 0 || tx >= Configuration.FieldWidth)
                {
                    instance.destroy();
                    return;
                }
                
                if(ty < 0 || ty >= Configuration.FieldHeights)
                {
                    instance.destroy();
                    return;
                }

                if(GameField.elements[ty].elements[tx].type == CellType.Wall)
                {
                    instance.destroy();
                    return;
                }

                Player.X = tx;
                Player.Y = ty;
                ReDrawPlayer(); 
                Loger.Log('move ' + direction.text);
            }

            instance.draw = function()
            {
                if(Player.Destroed) return;

                GameField.elements[Player.Y].elements[Player.X].draw();

                Loger.Log('draw');
            }

            return instance;
        }

        var robot_control = InitRobotControlClass();

        function InitQueue()
        {
            var instance = function() {};

            var list = [];

            instance.Add = function(elem)
            {
                list.push(elem);
            }

            instance.Execute = function()
            {
                var delay = 100;

                list.forEach((elem, i) => {
                    setTimeout(elem, (i + 1) * delay);
                });
            }

            instance.Clear = function()
            {
                list = [];
            }

            return instance;
        }

        var queue = InitQueue();

        function InitRobotClass(robot_control, queue)
        {
            var instance = function() {};

            instance.move = function(direction)
            {
                queue.Add(() => robot_control.move(direction));
            }

            instance.draw = function()
            {
                queue.Add(() => robot_control.draw());
            }

            return instance;
        }

        var robot = InitRobotClass(robot_control, queue);
        
        // robot.move(Directions.Up);
        // robot.move(Directions.Up);
        // robot.move(Directions.Up);
        // robot.move(Directions.Up);

        // queue.Execute();

        RunButton.onclick = function()
        {
            Player.Destroed = false;
            Player.X = (Configuration.FieldWidth / 2) | 0;
            Player.Y = (Configuration.FieldHeight / 2) | 0;

            ReDrawPlayer();
            Loger.Clear();
            GameField.clear();

            var f = new Function('robot', TextInput.value);
            f(robot);

            queue.Execute();

            queue.Clear();
        }

        ClearButton.onclick = function()
        {
            Player.Destroed = false;
            Player.X = (Configuration.FieldWidth / 2) | 0;
            Player.Y = (Configuration.FieldHeight / 2) | 0;

            ReDrawPlayer();
            GameField.clear();
        }

        TextInput.innerHTML = `for(var i = 0; i < 4; i++)
{
  robot.move(Directions.Up);
  robot.draw();
}`
    </script>
</body>
</html>